<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>以一个例子为线索 | 个人主页</title>
    <meta name="description" content="lien的知识库">
    
    
    <link rel="preload" href="/Blog/assets/css/0.styles.a52f7505.css" as="style"><link rel="preload" href="/Blog/assets/js/app.cdba929c.js" as="script"><link rel="preload" href="/Blog/assets/js/9.39a6e0ed.js" as="script"><link rel="prefetch" href="/Blog/assets/js/10.ffaea7b6.js"><link rel="prefetch" href="/Blog/assets/js/11.68cb89c6.js"><link rel="prefetch" href="/Blog/assets/js/12.c3f56d7b.js"><link rel="prefetch" href="/Blog/assets/js/13.c9c51a46.js"><link rel="prefetch" href="/Blog/assets/js/14.e84b061f.js"><link rel="prefetch" href="/Blog/assets/js/15.3b4cc0f6.js"><link rel="prefetch" href="/Blog/assets/js/16.96c6021e.js"><link rel="prefetch" href="/Blog/assets/js/17.e2982de3.js"><link rel="prefetch" href="/Blog/assets/js/18.d9a15a58.js"><link rel="prefetch" href="/Blog/assets/js/19.d99e73c0.js"><link rel="prefetch" href="/Blog/assets/js/2.f408895a.js"><link rel="prefetch" href="/Blog/assets/js/20.c5f4581d.js"><link rel="prefetch" href="/Blog/assets/js/21.3438a0b8.js"><link rel="prefetch" href="/Blog/assets/js/22.015a194d.js"><link rel="prefetch" href="/Blog/assets/js/23.efaebbb4.js"><link rel="prefetch" href="/Blog/assets/js/24.585b0621.js"><link rel="prefetch" href="/Blog/assets/js/25.ce34ef53.js"><link rel="prefetch" href="/Blog/assets/js/26.3ba8840d.js"><link rel="prefetch" href="/Blog/assets/js/3.9a2081a3.js"><link rel="prefetch" href="/Blog/assets/js/4.96ff7512.js"><link rel="prefetch" href="/Blog/assets/js/5.0b98e5f3.js"><link rel="prefetch" href="/Blog/assets/js/6.a43352fb.js"><link rel="prefetch" href="/Blog/assets/js/7.d7e26d93.js"><link rel="prefetch" href="/Blog/assets/js/8.b6302fc1.js">
    <link rel="stylesheet" href="/Blog/assets/css/0.styles.a52f7505.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Blog/" class="home-link router-link-active"><!----> <span class="site-name">个人主页</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/Blog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/knowledge/js/" class="nav-link router-link-active">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/Blog/lien-ui/" class="nav-link">UI框架</a></li><li class="dropdown-item"><!----> <a href="/Blog/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><a href="/Blog/work/" class="nav-link">工程</a></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://github.com/LienJack/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/Blog/" class="nav-link">主页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">知识</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Blog/knowledge/js/" class="nav-link router-link-active">JavaScript</a></li><li class="dropdown-item"><!----> <a href="/Blog/lien-ui/" class="nav-link">UI框架</a></li><li class="dropdown-item"><!----> <a href="/Blog/about/" class="nav-link">关于</a></li></ul></div></div><div class="nav-item"><a href="/Blog/work/" class="nav-link">工程</a></div><div class="nav-item"><a href="/Blog/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="https://github.com/LienJack/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading open"><span>javascript</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/Blog/knowledge/js/" class="sidebar-link">了解js</a></li><li><a href="/Blog/knowledge/js/1start-learn.html" class="sidebar-link">了解 Vue 这个项目</a></li><li><a href="/Blog/knowledge/js/2vue-constructor.html" class="sidebar-link">Vue 构造函数</a></li><li><a href="/Blog/knowledge/js/3vue-example.html" class="active sidebar-link">以一个例子为线索</a></li><li><a href="/Blog/knowledge/js/4vue-normalize.html" class="sidebar-link">Vue 选项的规范化</a></li><li><a href="/Blog/knowledge/js/5vue-merge.html" class="sidebar-link">Vue 选项的合并</a></li><li><a href="/Blog/knowledge/js/6vue-init-start.html" class="sidebar-link">Vue 的初始化之开篇</a></li><li><a href="/Blog/knowledge/js/7vue-reactive.html" class="sidebar-link">揭开数据响应系统的面纱</a></li><li><a href="/Blog/knowledge/js/8vue-reactive-dep-watch.html" class="sidebar-link">渲染函数的观察者与进阶的数据响应系统</a></li><li><a href="/Blog/knowledge/js/9vue-state-init.html" class="sidebar-link">其他重要选项的初始化及实现</a></li><li><a href="/Blog/knowledge/js/80vue-compiler-start.html" class="sidebar-link">Vue 的编译器初探</a></li><li><a href="/Blog/knowledge/js/81vue-lexical-analysis.html" class="sidebar-link">词法分析 - 为生成AST做准备</a></li><li><a href="/Blog/knowledge/js/82vue-parsing.html" class="sidebar-link">句法分析 - 生成真正的AST(一)</a></li><li><a href="/Blog/knowledge/js/83vue-parsing-2.html" class="sidebar-link">句法分析 - 生成真正的AST(二)</a></li><li><a href="/Blog/knowledge/js/84vue-codegen.html" class="sidebar-link">编译器之代码的生成</a></li><li><a href="/Blog/knowledge/js/85vue-vdom.html" class="sidebar-link">虚拟DOM解析</a></li><li><a href="/Blog/knowledge/js/86vue-vdom-patch.html" class="sidebar-link">虚拟DOM补丁算法详解</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="以一个例子为线索"><a href="#以一个例子为线索" aria-hidden="true" class="header-anchor">#</a> 以一个例子为线索</h1> <p>在上一节 <a href="/Blog/knowledge/js/2vue-constructor.html">Vue构造函数</a> 中，我们整理了完整的 <code>Vue</code> 构造函数，包括原型的设计和全局API的设计，并且我们专门为其整理了附录，目的是便于查看相应的方法和属性是在哪里被添加的，同时也让我们对 <code>Vue</code> 构造函数有一个大局观的认识。</p> <p>从这一章节开始，我们将逐渐走进 <code>Vue</code>，我们采用一种由浅入深，由宽到窄的思路，一开始我们会从宏观的角度来看 <code>Vue</code> 是如何设计的，然后再一点点“追究”进去，进而逐步搞清楚 <code>Vue</code> 为什么这么设计。</p> <p>而这一节，我们就致力于搞清楚：<code>Vue的思路</code>。我们将会从一个例子开始，这个例子非常简单，如下：</p> <p>我们有如下模板：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{test}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>和这样一段 <code>js</code> 代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这段 <code>js</code> 代码很简单，只是简单地调用了 <code>Vue</code>，传递了两个选项 <code>el</code> 以及 <code>data</code>。这段代码的最终效果就是在页面中渲染为如下 <code>DOM</code>：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div><p>其中
<code>{{ test }}</code>
被替换成了 <code>1</code>，并且当我们尝试修改 <code>data.test</code> 的值的时候</p></div> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$data<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">// 或</span>
vm<span class="token punctuation">.</span>test <span class="token operator">=</span> <span class="token number">2</span>
</code></pre></div><p>那么页面的 <code>DOM</code> 也会随之变化为：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>看上去这个例子很简单(好吧，确实很简单)，但其实这么简单的例子已经足够我们搞清楚 <code>Vue</code> 的思路了，当你明白 <code>Vue</code> 的思路之后，再去搞清楚其他的问题将会变得异常轻松。接下来我们就看看上面的例子中，到底发生了什么。</p> <p>首先我们要找到当我们调用 <code>Vue</code> 构造函数的时候，第一句执行的代码是什么，所以我们要找到 <code>Vue</code> 的构造函数，还记得 <code>Vue</code> 的构造函数定义在哪里吗？不记得没关系，只要查阅一下 <a href="/Blog/knowledge/appendix/vue-prototype.html">附录/Vue构造函数整理-原型</a> 就ok了，<code>Vue</code> 的构造函数定义在 <code>core/instance/index.js</code> 文件中，我们找到它：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Vue</span> <span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">Vue</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Vue is a constructor and should be called with the `new` keyword'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_init</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一目了然，当我们使用 <code>new</code> 操作符调用 <code>Vue</code> 的时候，第一句执行的代码就是 <code>this._init(options)</code> 方法，其中 <code>options</code> 是我们调用 <code>Vue</code> 构造函数时透传过来的，也就是说：</p> <div class="language-js extra-class"><pre class="language-js"><code>options <span class="token operator">=</span> <span class="token punctuation">{</span>
    el<span class="token punctuation">:</span> <span class="token string">'#app'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        test<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>既然如此，我们就找到 <code>_init</code> 方法，查阅 <a href="/Blog/knowledge/appendix/vue-prototype.html">附录/Vue构造函数整理-原型</a> 可知，<code>_init</code> 方法在 <code>src/core/instance/init.js</code> 文件被添加到 <code>Vue</code> 的原型上，下面我们就看看 <code>_init</code> 做了什么。</p> <p><code>_init</code> 方法的一开始，是这两句代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> vm<span class="token punctuation">:</span> Component <span class="token operator">=</span> <span class="token keyword">this</span>
<span class="token comment">// a uid</span>
vm<span class="token punctuation">.</span>_uid <span class="token operator">=</span> uid<span class="token operator">++</span>
</code></pre></div><p>首先声明了常量 <code>vm</code>，其值为 <code>this</code> 也就是当前这个 <code>Vue</code> 实例啦，然后在实例上添加了一个唯一标示：<code>_uid</code>，其值为 <code>uid</code>，<code>uid</code> 这个变量定义在 <code>initMixin</code> 方法的上面，初始化为 <code>0</code>，可以看到每次实例化一个 <code>Vue</code> 实例之后，<code>uid</code> 的值都会 <code>++</code>。</p> <p>所以实际 <code>_uid</code> 就是一个 <code>Vue</code> 实例的实例属性，在之后的分析中，我们将会在很多地方遇到很多的实例属性被逐渐添加到 <code>Vue</code> 实例上，所以我们同样整理了一个附录：<a href="/Blog/knowledge/appendix/vue-ins.html">附录/Vue实例的设计</a> 来对 <code>Vue</code> 实例进行整理，就像我们对 <code>Vue</code> 构造函数的整理一样，大家可以在这里查阅。</p> <p>回过头来继续看代码，接下来是这样一段：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> startTag<span class="token punctuation">,</span> endTag
<span class="token comment">/* istanbul ignore if */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    startTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-start:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    endTag <span class="token operator">=</span> <span class="token template-string"><span class="token string">`vue-perf-end:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span>
    <span class="token function">mark</span><span class="token punctuation">(</span>startTag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 中间的代码省略...</span>

<span class="token comment">/* istanbul ignore if */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token function">formatComponentName</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token function">mark</span><span class="token punctuation">(</span>endTag<span class="token punctuation">)</span>
    <span class="token function">measure</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`vue </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>vm<span class="token punctuation">.</span>_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> init`</span></span><span class="token punctuation">,</span> startTag<span class="token punctuation">,</span> endTag<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码中，我省略了这两段代码中间的内容，我们暂且只看这两段代码。首先声明两个变量 <code>startTag</code> 和 <code>endTag</code>，然后这两段代码有一个共同点，即拥有相同的判断语句：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span>performance <span class="token operator">&amp;&amp;</span> mark<span class="token punctuation">)</span>
</code></pre></div><p>意思是：在非生产环境下，并且 <code>config.performance</code> 和 <code>mark</code> 都为真，那么才执行里面的代码，其中 <code>config.performance</code> 来自于 <code>core/config.js</code> 文件，我们知道，<code>Vue.config</code> 同样引用了这个对象，在 <code>Vue</code> 的官方文档中可以看到如下内容：</p> <p><img src="http://ovjvjtt4l.bkt.clouddn.com/2017-09-28-114949.jpg" alt></p> <p><code>Vue</code> 提供了全局配置 <code>Vue.config.performance</code>，我们通过将其设置为 <code>true</code>，即可开启性能追踪，你可以追踪四个场景的性能：</p> <ul><li>1、组件初始化(<code>component init</code>)</li> <li>2、编译(<code>compile</code>)，将模板(<code>template</code>)编译成渲染函数</li> <li>3、渲染(<code>render</code>)，其实就是渲染函数的性能，或者说渲染函数执行且生成虚拟DOM(<code>vnode</code>)的性能</li> <li>4、打补丁(<code>patch</code>)，将虚拟DOM渲染为真实DOM的性能</li></ul> <p>其中<em>组件初始化</em>的性能追踪就是我们在 <code>_init</code> 方法中看到的那样去实现的，其实现的方式就是在初始化的代码的开头和结尾分别使用 <code>mark</code> 函数打上两个标记，然后通过 <code>measure</code> 函数对这两个标记点进行性能计算。<code>mark</code> 和 <code>measure</code> 这两个函数可以在附录 <a href="/Blog/knowledge/appendix/core-util.html">core/util 目录下的工具方法全解</a> 中查看其作用和实现方式。</p> <p>此时大家应该打开 <code>core/util/perf.js</code> 文件，然后对照着附录 <a href="/Blog/knowledge/appendix/core-util.html">core/util 目录下的工具方法全解</a> 搞清楚 <code>mark</code> 和 <code>measure</code> 这两个方法了，通过 <code>core/util/perf.js</code> 文件的代码我们可知，只有在非生产环境，且浏览器必须支持 <code>window.performance</code> API的情况下才会导出有用的 <code>mark</code> 和 <code>measure</code> 函数，也就是说，如果你的浏览器不支持 <code>window.performance</code> 那么在 <code>core/instance/init.js</code> 文件中导入的 <code>mark</code> 和 <code>measure</code> 就都是 <code>undefined</code>，也就不会执行 <code>if</code> 语句里面的内容。</p> <p>那么大家可能比较关心如何查看追踪到的性能数据，很简单，如下图，打开 <code>chrome</code> 开发者工具即可查看：</p> <p><img src="http://ovjvjtt4l.bkt.clouddn.com/2017-09-29-022249.jpg" alt></p> <p>如上图所示，这是我们本节这个小例子所追踪到的性能数据，在实际开发中 <code>Vue</code> 的各个阶段要做的工作肯定要复杂的多，如果能够很好的利用这些性能数据，将会为你提供很大的改进意见。</p> <p>了解了这两段性能追踪的代码之后，我们再来看看这两段代码中间的代码，也就是被追踪性能的代码，如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// a flag to avoid this being observed</span>
vm<span class="token punctuation">.</span>_isVue <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token comment">// merge options</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// optimize internal component instantiation</span>
    <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
    <span class="token comment">// internal component options needs special treatment.</span>
    <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
    options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    vm
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/* istanbul ignore else */</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
<span class="token punctuation">}</span>
<span class="token comment">// expose real self</span>
vm<span class="token punctuation">.</span>_self <span class="token operator">=</span> vm
<span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
<span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
<span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
</code></pre></div><p>上面的代码是那两段性能追踪的代码之间全部的内容，我们逐一分析，首先在 <code>Vue</code> 实例上添加 <code>_isVue</code> 属性，并设置其值为 <code>true</code>。目的是用来标识一个对象是 <code>Vue</code> 实例，即如果发现一个对象拥有 <code>_isVue</code> 属性并且其值为 <code>true</code>，那么就代表该对象是 <code>Vue</code> 实例。这样可以避免该对象被响应系统观测（其实在其他地方也有用到，但是宗旨都是一样的，这个属性就是用来告诉你：我不是普通的对象，我是Vue实例）。</p> <p>再往下是这样一段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// merge options</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>_isComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// optimize internal component instantiation</span>
    <span class="token comment">// since dynamic options merging is pretty slow, and none of the</span>
    <span class="token comment">// internal component options needs special treatment.</span>
    <span class="token function">initInternalComponent</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
        <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
        options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        vm
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码是一段 <code>if</code> 分支语句，条件是：<code>options &amp;&amp; options._isComponent</code>，其中 <code>options</code> 就是我们调用 <code>Vue</code> 时传递的参数选项，但 <code>options._isComponent</code> 是什么鬼？我们知道在本节的例子中我们的 <code>options</code> 对象只有两个属性 <code>el</code> 和 <code>data</code>，并且在 <code>Vue</code> 的官方文档中你也找不到关于 <code>_isComponent</code> 这个选项的介绍，其实我相信大部分同学都已经知道，这是一个内部选项。而事实也确实是这样，这个内部选项是在 <code>Vue</code> 创建组件的时候才会有的，为了不牵涉太多内容导致大家头晕，这里暂时不介绍其相关内容。</p> <p>根据本节的例子，上面的代码必然会走 <code>else</code> 分支，也就是这段代码：</p> <div class="language-js extra-class"><pre class="language-js"><code>vm<span class="token punctuation">.</span>$options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token function">resolveConstructorOptions</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>constructor<span class="token punctuation">)</span><span class="token punctuation">,</span>
    options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    vm
<span class="token punctuation">)</span>
</code></pre></div><p>这段代码在 <code>Vue</code> 实例上添加了 <code>$options</code> 属性，在 <code>Vue</code> 的官方文档中，你能够查看到 <code>$options</code> 属性的作用，这个属性用于当前 <code>Vue</code> 的初始化，什么意思呢？大家要注意我们现在的阶段处于 <code>_init()</code> 方法中，在 <code>_init()</code> 方法的内部大家可以看到一系列 <code>init*</code> 的方法，比如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initLifecycle</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initEvents</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initRender</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'beforeCreate'</span><span class="token punctuation">)</span>
<span class="token function">initInjections</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve injections before data/props</span>
<span class="token function">initState</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
<span class="token function">initProvide</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token comment">// resolve provide after data/props</span>
<span class="token function">callHook</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> <span class="token string">'created'</span><span class="token punctuation">)</span>
</code></pre></div><p>而这些方法才是真正起作用的一些初始化方法，大家可以找到这些方法看一看，在这些初始化方法中，无一例外的都使用到了实例的 <code>$options</code> 属性，即 <code>vm.$options</code>。所以 <code>$options</code> 这个属性的的确确是用于 <code>Vue</code> 实例初始化的，只不过在初始化之前，我们需要一些手段来产生 <code>$options</code> 属性，而这就是 <code>mergeOptions</code> 函数的作用，接下来我们就来看看 <code>mergeOptions</code> 都做了些什么，又有什么意义。</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Blog/knowledge/js/2vue-constructor.html" class="prev">
          Vue 构造函数
        </a></span> <span class="next"><a href="/Blog/knowledge/js/4vue-normalize.html">
          Vue 选项的规范化
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Blog/assets/js/app.cdba929c.js" defer></script><script src="/Blog/assets/js/9.39a6e0ed.js" defer></script>
  </body>
</html>
